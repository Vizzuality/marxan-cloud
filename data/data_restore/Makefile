.DEFAULT_GOAL := restore
# We need to use the content.json autogenerated file to get the latest data date in order to download it
LATEST_DATE := $(shell curl -sS 'https://marxancloudtest.blob.core.windows.net/data-ingestion-test-00/dbs-dumps/content.json' \
		-H 'content-type: application/json;charset=UTF-8' \
		--compressed | jq '.metadata.latest.name')

restore: restore-api | restore-geodb

restore-api: api_db-${LATEST_DATE}.tar.gz
	@echo "Restoring api dbs dumps..."
	mkdir ./$$(basename $< .tar.gz)/
	tar -xvf ./db_dumps/$< -C ./$$(basename $< .tar.gz)/ && pg_restore --superuser $$API_POSTGRES_USER -a -d "postgresql://$$API_POSTGRES_USER:$$API_POSTGRES_PASSWORD@$$API_POSTGRES_HOST:$$API_POSTGRES_PORT/$$API_POSTGRES_DB"  -Fd ./$$(basename $< .tar.gz) --disable-triggers
	rm -rf $$(basename $< .tar.gz)/
restore-geodb: geo_db-${LATEST_DATE}.tar.gz
	@echo "Restoring geo dbs dumps..."
	mkdir ./$$(basename $< .tar.gz)/
	tar -xvf ./db_dumps/$< -C ./$$(basename $< .tar.gz)/ && pg_restore --superuser $$GEO_POSTGRES_USER -a -d "postgresql://$$GEO_POSTGRES_USER:$$GEO_POSTGRES_PASSWORD@$$GEO_POSTGRES_HOST:$$GEO_POSTGRES_PORT/$$GEO_POSTGRES_DB" -Fd ./$$(basename $< .tar.gz) --disable-triggers
	rm -rf $$(basename $< .tar.gz)/

api_db-${LATEST_DATE}.tar.gz:
	cd ./db_dumps/ && curl -O https://marxancloudtest.blob.core.windows.net/data-ingestion-test-00/dbs-dumps/api_db-${LATEST_DATE}.tar.gz

geo_db-${LATEST_DATE}.tar.gz:
	cd ./db_dumps/ && curl -O https://marxancloudtest.blob.core.windows.net/data-ingestion-test-00/dbs-dumps/geo_db-${LATEST_DATE}.tar.gz
